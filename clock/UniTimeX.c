#include "UniTimeX.h"

#include "GD32E503.h"
#include "BitCodec.h"


int initUniTimeX(void)
{
	// GD32E503_RCU_APB1RST
	// TIMER1RST [0]
	REG32_SET_BIT(GD32E503_RCU(GD32E503_RCU_APB1RST), 0, 0b1);
	// GD32E503_RCU_APB1EN
	// TIMER1EN [0]
	REG32_SET_BIT(GD32E503_RCU(GD32E503_RCU_APB1EN), 0, 0b1);
	
	// GD32E503_RCU_APB1RST
	// TIMER1RST [0]
	REG32_SET_BIT(GD32E503_RCU(GD32E503_RCU_APB1RST), 0, 0b0);
	
	// GD32E503_TIMER_CTL0
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_CTL0), 0);
	
	// GD32E503_TIMER_CTL1
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_CTL1), 0);
	
	// GD32E503_TIMER_SMCFG
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_SMCFG), 0);
	
	// GD32E503_TIMER_DMAINTEN
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_DMAINTEN), 0);
	
	// GD32E503_TIMER_SWEVG
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_SWEVG), 0);
	
	// GD32E503_TIMER_INTF
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_INTF), 0);
	
	// GD32E503_TIMER_PSC
	// PSC_TIMER1 = CK_APB1 / 1 = 50MHz
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_PSC), 0);
	
	// GD32E503_TIMER_CAR
	// CARL [31:0] 0xFFFFFFFF
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_CAR), 0xFFFFFFFF);
	
	// GD32E503_TIMER_CFG
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_CFG), 0);
	
	// GD32E503_TIMER_CHTCL2
	REG32_SET(GD32E503_TIMER1(GD32E503_TIMERL0_CHCTL2), 0);
	
	// GD32E503_TIMER_CTL0
	// CKDIV [9:8] 0b00 CK_TIMER1 = PSC_TIMER1 / 1 = 50MHz
	// ARSE [7] 0b0 Disable TIMER1_CAR shadow register
	// CAM [6:5] 0b00 Direction by DIR
	// DIR [4] 0b0 Count up
	// SPM [3] 0b0 Pulse disable
	// UPS [2] 0b0
	// UPDIS [1] 0b1 Update event disable
	// CEN [0] 0b1 Timer enable
	REG32_SET_RANGE(GD32E503_TIMER1(GD32E503_TIMERL0_CTL0), 1, 0, 0b11);
	
	return 0;
}

uint32_t getUniTimeX(void)
{
	// GD32E503_TIMER_CNT
	return REG32_GET(GD32E503_TIMER1(GD32E503_TIMERL0_CNT));
}
